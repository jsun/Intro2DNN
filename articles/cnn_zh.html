<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>物体识别入门 • Intro2DNN</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="物体识别入门">
<meta property="og:description" content="Intro2DNN">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Intro2DNN</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cnn.html">Introduction to image recognition with deep learning</a>
    </li>
    <li>
      <a href="../articles/cnn_zh.html">物体识别入门</a>
    </li>
    <li>
      <a href="../articles/lstm.html">Prediction of CRISPR guide RNA activity with deep learning</a>
    </li>
    <li>
      <a href="../articles/lstm_ja.html">深層学習を利用した CRISPR guide RNA の活性予測</a>
    </li>
    <li>
      <a href="../articles/lstm_zh.html">基于深度学习预测 CRISPR guide RNA 的切割效率</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jsun/Intro2DNN">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="cnn_zh_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>物体识别入门</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jsun/Intro2DNN/blob/master/vignettes/cnn_zh.Rmd"><code>vignettes/cnn_zh.Rmd</code></a></small>
      <div class="hidden name"><code>cnn_zh.Rmd</code></div>

    </div>

    
    
<div id="摘要" class="section level2">
<h2 class="hasAnchor">
<a href="#%E6%91%98%E8%A6%81" class="anchor"></a>摘要</h2>
<p>卷积神经网络（Convolutional neural network; CNN）是用于物体识别的深度神经网络架构之一。使用传统的机器学习算法来识别图像中的物体时，需要我们自己指定物体的特征，比如颜色、大小、长宽比例等。相比之下，CNN 可以通过学习大量的图像，从中自动提取物体的特征。 因此，使用 CNN 搭建物体识别模型时，只需收集大量的图像，而无需开发新的算法来提取特征。如今，这种简单易行的方法在许多研究领域备受欢迎。在本次研讨会上，我们将学习如何使用 torch 来搭建 CNN 模型进行图像识别。</p>
<div id="课程目标" class="section level3">
<h3 class="hasAnchor">
<a href="#%E8%AF%BE%E7%A8%8B%E7%9B%AE%E6%A0%87" class="anchor"></a>课程目标</h3>
<p>在本次研习会上，我们将通过开发简单的卷积神经网络来学习深度神经网络是怎样识别图片中的物体的。通过本次研习会，大家可以了解到以下内容。</p>
<ul>
<li>神经网络的基本概念</li>
<li>CNN 的基本概念</li>
<li>使用 R 搭建深度学习模型的方法</li>
</ul>
</div>
<div id="课前准备" class="section level3">
<h3 class="hasAnchor">
<a href="#%E8%AF%BE%E5%89%8D%E5%87%86%E5%A4%87" class="anchor"></a>课前准备</h3>
<p>参加本次研习会需掌握以下知识点。</p>
<ul>
<li>R 语言的基础语法（安装 R 包、保存与读取数据文件、<code>for</code> 句、定义函数等）。</li>
<li>数学的基础知识（多元函数、线性组合、微分等）。</li>
</ul>
<p>由于本次研习会重点讲解深度学习的基本知识，我们不推荐已经熟悉深度学习算法或能够使用 Python 等其他编程语言搭建模型的人员参加。</p>
</div>
</div>
<div id="初始配置" class="section level2">
<h2 class="hasAnchor">
<a href="#%E5%88%9D%E5%A7%8B%E9%85%8D%E7%BD%AE" class="anchor"></a>初始配置</h2>
<p>本次研习会上，我们主要使用 Torch <span class="citation">(PBC 2021)</span> 以及 coro <span class="citation">(Henry 2021)</span> 进行深度学习，使用 jpeg 读取图像，并使用 tidyverse 进行可视化。</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'jpeg'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'tidyverse'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'coro'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'torch'</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://torch.mlverse.org/docs">'torch'</a></span><span class="op">)</span>
<span class="fu"><a href="https://torch.mlverse.org/docs/reference/install_torch.html">install_torch</a></span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">1200</span><span class="op">)</span></code></pre></div>
<p>重启 R，然后将 R 包加载。</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://www.rforge.net/jpeg/">'jpeg'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyverse.tidyverse.org">'tidyverse'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/r-lib/coro">'coro'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://torch.mlverse.org/docs">'torch'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://torchvision.mlverse.org">'torchvision'</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="数据整合" class="section level2">
<h2 class="hasAnchor">
<a href="#%E6%95%B0%E6%8D%AE%E6%95%B4%E5%90%88" class="anchor"></a>数据整合</h2>
<div id="读取数据" class="section level3">
<h3 class="hasAnchor">
<a href="#%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE" class="anchor"></a>读取数据</h3>
<p>在本次研讨会上，我们使用在 TensorFlow Datasets 网站上公开的一个叫做 <a href="https://www.tensorflow.org/datasets/catalog/tf_flowers">tf_flower</a> 图像数据集来搭建一个物体识别的深度学习模型。为了方便操作，我们使用以下代码来下载以及整理数据。</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="st">'flower_photos'</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"train_photos"</span>, recursive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"train_photos_train"</span>, recursive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"train_photos_valid"</span>, recursive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">tf_flowers</span> <span class="op">&lt;-</span> <span class="st">'https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz'</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span><span class="va">tf_flowers</span>, destfile <span class="op">=</span> <span class="st">'flower_photos.tgz'</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/untar.html">untar</a></span><span class="op">(</span><span class="st">'flower_photos.tgz'</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">'flower_photos'</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.remove</a></span><span class="op">(</span><span class="st">'flower_photos/LICENSE.txt'</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">'flower_photos/sunflowers'</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; [1] "1008566138_6927679c8a.jpg"    "1022552002_2b93faf9e7_n.jpg" </span>
<span class="co">#&gt; [3] "1022552036_67d33d5bd8_n.jpg"  "10386503264_e05387e1f7_m.jpg"</span>
<span class="co">#&gt; [5] "10386522775_4f8c616999_m.jpg" "10386525005_fd0b7d6c55_n.jpg"</span></code></pre></div>
</div>
<div id="数据预处理" class="section level3">
<h3 class="hasAnchor">
<a href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86" class="anchor"></a>数据预处理</h3>
<p>在这里，我们需大致的了解一下这套数据的构造，比方说这套数据包含着多少个类别，每个类别里有多少张图片。这些信息会在搭建模型或训练模型时用到</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train_images</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">class</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">'flower_photos'</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">train_images</span><span class="op">[[</span><span class="va">class</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'flower_photos'</span>, <span class="va">class</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">train_images</span><span class="op">)</span>,
           n_images <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">train_images</span>, <span class="va">length</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://torch.mlverse.org/docs/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">class</span>, y <span class="op">=</span> <span class="va">n_images</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">'identity'</span><span class="op">)</span></code></pre></div>
<p><img src="cnn_zh_files/figure-html/unnamed-chunk-6-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>从运行结果中，我们可以看到这套数据一共有五个类别。每个类别都包含着 600 张以上的图像，其中 dandelion 和 daisy 类中的图像数量的差距还是有点大。一般讲在训练模型时，最理想的情况下是需要保证每个类别中的样本数相似。因此，当我们使用类别间样本数的差距比较大的数据时，我们需要调整每个类别中的样本量。比较简单的方案有以下两种。</p>
<ul>
<li>从样本数比较多的类别里随机删掉一些样本。</li>
<li>使用一些数据扩增（data augmentation）的方法，将样本数少的类别里的数据扩增。</li>
</ul>
<p>在这里，为了节省时间，我们在每个类别里挑选 20 张图像作为训练集用于训练模型。另外，我们还在每个类别里挑选了 10 张图像作为验证集用于验证模型的性能。</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_train_images</span> <span class="op">&lt;-</span> <span class="fl">20</span>
<span class="va">n_valid_images</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">class_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'dandelion'</span>, <span class="st">'sunflowers'</span>, <span class="st">'roses'</span>, <span class="st">'tulips'</span>, <span class="st">'daisy'</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="st">'flower_photos_train'</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="st">'flower_photos_valid'</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">class</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">train_images</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">class</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">class_labels</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'flower_photos_train'</span>, <span class="va">class</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'flower_photos_valid'</span>, <span class="va">class</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

        <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">train_images</span><span class="op">[[</span><span class="va">class</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
            <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">&lt;=</span> <span class="va">n_train_images</span><span class="op">)</span> <span class="op">{</span>
                <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'flower_photos'</span>, <span class="va">class</span>, <span class="va">train_images</span><span class="op">[[</span><span class="va">class</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'flower_photos_train'</span>, <span class="va">class</span>, <span class="va">train_images</span><span class="op">[[</span><span class="va">class</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
            <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">n_train_images</span> <span class="op">&lt;</span> <span class="va">i</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">&lt;=</span> <span class="va">n_train_images</span> <span class="op">+</span> <span class="va">n_valid_images</span><span class="op">)</span> <span class="op">{</span>
                <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'flower_photos'</span>, <span class="va">class</span>, <span class="va">train_images</span><span class="op">[[</span><span class="va">class</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'flower_photos_valid'</span>, <span class="va">class</span>, <span class="va">train_images</span><span class="op">[[</span><span class="va">class</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
      <span class="op">}</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>待我们整理好训练集以及验证集之后，我们分别为这两组数据集定义一个预处理的流程。</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train_transforms</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/transform_to_tensor.html">transform_to_tensor</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>
    <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/transform_resize.html">transform_resize</a></span><span class="op">(</span><span class="va">img</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">512</span>, <span class="fl">512</span><span class="op">)</span><span class="op">)</span>
    <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/transform_random_resized_crop.html">transform_random_resized_crop</a></span><span class="op">(</span><span class="va">img</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">224</span>, <span class="fl">224</span><span class="op">)</span><span class="op">)</span>
    <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/transform_color_jitter.html">transform_color_jitter</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>
    <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/transform_random_horizontal_flip.html">transform_random_horizontal_flip</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>
    <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/transform_normalize.html">transform_normalize</a></span><span class="op">(</span><span class="va">img</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span><span class="op">)</span>, std <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span><span class="op">)</span><span class="op">)</span>
    <span class="va">img</span>
<span class="op">}</span>

<span class="va">valid_transforms</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/transform_to_tensor.html">transform_to_tensor</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>
    <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/transform_resize.html">transform_resize</a></span><span class="op">(</span><span class="va">img</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">256</span>, <span class="fl">256</span><span class="op">)</span><span class="op">)</span>
    <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/transform_center_crop.html">transform_center_crop</a></span><span class="op">(</span><span class="va">img</span>, <span class="fl">224</span><span class="op">)</span>
    <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/transform_normalize.html">transform_normalize</a></span><span class="op">(</span><span class="va">img</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span><span class="op">)</span>, std <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span><span class="op">)</span><span class="op">)</span>
    <span class="va">img</span>
<span class="op">}</span></code></pre></div>
<p>下一步我们将整理好的训练集的路径赋予给 <code>image_folder_dataset</code> 函数，让其从中自动获取分组信息，图片信息，以及对每个图片做好预处理的准备。随后我们将 <code>image_folder_dataset</code> 输出的对象赋予给 <code>dataloader</code>，让其准备归纳图片准备带入到模型中训练。</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataset_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/image_folder_dataset.html">image_folder_dataset</a></span><span class="op">(</span><span class="st">'flower_photos_train'</span>, transform <span class="op">=</span> <span class="va">train_transforms</span><span class="op">)</span>
<span class="va">dataset_train</span><span class="op">$</span><span class="va">classes</span>
<span class="co">#&gt; [1] "daisy"      "dandelion"  "roses"      "sunflowers" "tulips"</span>
<span class="va">dataloader_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset_train</span>, batch_size <span class="op">=</span> <span class="fl">2</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="模型构建" class="section level2">
<h2 class="hasAnchor">
<a href="#%E6%A8%A1%E5%9E%8B%E6%9E%84%E5%BB%BA" class="anchor"></a>模型构建</h2>
<div id="框架设计" class="section level3">
<h3 class="hasAnchor">
<a href="#%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1" class="anchor"></a>框架设计</h3>
<p>使用 torch 包创建深度学习模型时，须按照 torch 的规定，先设计一个神经网络的框架模版，然后利用其模版生成一个模型实例。 在这里我们设计一个接收一张图片然后输出 <code>length(dataset_train$classes)</code> 个数值的神经网络框架。 其框架由两个部分构成。第一个组件是有卷积层与池化层构成，主要用于提取图像中的特征量。第二个组件由三层全连接层构成，用于使用特征量来识别图中的物体。由于第一个组件的输出结果是矩阵，而第二个组件的输入形式是向量，我们还需要在两者中间转换数据形式。</p>
<p>以下是我们定义一个名为 SimpleCNN 的神经网络的框架模型的代码。<code>initialize</code> 函数来定义组件，随后用 <code>forward</code> 函数把每个组件按顺序连接起来。</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">SimpleCNN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_module.html">nn_module</a></span><span class="op">(</span>
    <span class="st">"SimpleCNN"</span>,
    
    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_classes</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">self</span><span class="op">$</span><span class="va">conv1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_conv2d.html">nn_conv2d</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">16</span>, <span class="fl">5</span><span class="op">)</span>
        <span class="va">self</span><span class="op">$</span><span class="va">pool1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_max_pool2d.html">nn_max_pool2d</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>
        <span class="va">self</span><span class="op">$</span><span class="va">conv2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_conv2d.html">nn_conv2d</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">32</span>, <span class="fl">5</span><span class="op">)</span>
        <span class="va">self</span><span class="op">$</span><span class="va">pool2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_max_pool2d.html">nn_max_pool2d</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>
      
        <span class="va">n_inputs</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="fl">224</span> <span class="op">-</span> <span class="fl">5</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">5</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">*</span> <span class="fl">32</span>

        <span class="va">self</span><span class="op">$</span><span class="va">fc1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="va">n_inputs</span>, out_features <span class="op">=</span> <span class="fl">512</span><span class="op">)</span>
        <span class="va">self</span><span class="op">$</span><span class="va">fc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">512</span>, out_features <span class="op">=</span> <span class="fl">64</span><span class="op">)</span>
        <span class="va">self</span><span class="op">$</span><span class="va">fc3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">64</span>, out_features <span class="op">=</span> <span class="va">n_classes</span><span class="op">)</span>
    <span class="op">}</span>,
  
    forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">conv1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">pool1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">conv2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">pool2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
      
        <span class="co"># convert a matrix to a vector</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_flatten.html">torch_flatten</a></span><span class="op">(</span><span class="va">x</span>, start_dim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
      
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">fc1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">fc2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">fc3</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span>
    <span class="op">}</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="模型训练" class="section level3">
<h3 class="hasAnchor">
<a href="#%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83" class="anchor"></a>模型训练</h3>
<p>下一步我们将利用 SimpleCNN 模版生成一个模型实例 <code>model</code>，然后对这个实例 <code>model</code> 进行训练以及验证。</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">SimpleCNN</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dataset_train</span><span class="op">$</span><span class="va">classes</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>在开始训练模型之前，我们需要制定一些训练参数，即损失函数以及优化算法。我们的目的是要做物体识别。因此，在这里我们将采用最常用的交叉熵作为训练时的损失函数。另外，我们将采用 Adam 算法来优化模型。Adam 优化算法是很常用的算法之一并适用于大多是场合。</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">criterion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_cross_entropy_loss.html">nn_cross_entropy_loss</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">optimizer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/optim_adam.html">optim_adam</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span></code></pre></div>
<p>接下来，我们将准备好的数据集和模型传送到 CPU 或 GPU 上进行模型训练。在这里，我们借助 <code>for</code> 循环使用同样的训练集反复训练模型 5 次（epoch）。在每次 epoch 训练中，我们将 <code>dataloader</code> 定义后的训练集赋予给模型进行训练。</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span>
<span class="va">model</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="op">)</span>

<span class="va">loss_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">loss_running</span> <span class="op">&lt;-</span> <span class="fl">0</span>
    <span class="va">n_train_samples</span> <span class="op">&lt;-</span> <span class="fl">0</span>

    <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="va">dataloader_train</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">optimizer</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span>
        <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
        <span class="va">loss</span> <span class="op">&lt;-</span> <span class="fu">criterion</span><span class="op">(</span><span class="va">output</span>, <span class="va">b</span><span class="op">$</span><span class="va">y</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
        <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span>
        <span class="va">optimizer</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span>
        
        <span class="va">loss_running</span> <span class="op">&lt;-</span> <span class="va">loss_running</span> <span class="op">+</span> <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
        <span class="va">n_train_samples</span> <span class="op">&lt;-</span> <span class="va">n_train_samples</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="va">loss_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">loss_train</span>, <span class="va">loss_running</span> <span class="op">/</span> <span class="va">n_train_samples</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"epoch %d  loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="va">loss_running</span> <span class="op">/</span> <span class="va">n_train_samples</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; epoch 1  loss: 1.731946</span>
<span class="co">#&gt; epoch 2  loss: 1.621100</span>
<span class="co">#&gt; epoch 3  loss: 1.573147</span>
<span class="co">#&gt; epoch 4  loss: 1.483027</span>
<span class="co">#&gt; epoch 5  loss: 1.475343</span></code></pre></div>
<p>我们可以看到随着迭代次数的增加，误差也在逐渐下降。</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>epoch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">loss_train</span><span class="op">)</span>, loss <span class="op">=</span> <span class="va">loss_train</span><span class="op">)</span> <span class="op"><a href="https://torch.mlverse.org/docs/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epoch</span>, y <span class="op">=</span> <span class="va">loss</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="cnn_zh_files/figure-html/unnamed-chunk-14-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>为了完善模型提高其性能，我们可以再多训练几次模型。在这里，让我们多训练 5 次模型。</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">6</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">loss_running</span> <span class="op">&lt;-</span> <span class="fl">0</span>
    <span class="va">n_train_samples</span> <span class="op">&lt;-</span> <span class="fl">0</span>

    <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="va">dataloader_train</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">optimizer</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span>
        <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
        <span class="va">loss</span> <span class="op">&lt;-</span> <span class="fu">criterion</span><span class="op">(</span><span class="va">output</span>, <span class="va">b</span><span class="op">$</span><span class="va">y</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
        <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span>
        <span class="va">optimizer</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span>
        
        <span class="va">loss_running</span> <span class="op">&lt;-</span> <span class="va">loss_running</span> <span class="op">+</span> <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
        <span class="va">n_train_samples</span> <span class="op">&lt;-</span> <span class="va">n_train_samples</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="va">loss_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">loss_train</span>, <span class="va">loss_running</span> <span class="op">/</span> <span class="va">n_train_samples</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"epoch %d  loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="va">loss_running</span> <span class="op">/</span> <span class="va">n_train_samples</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; epoch 6  loss: 1.400292</span>
<span class="co">#&gt; epoch 7  loss: 1.609004</span>
<span class="co">#&gt; epoch 8  loss: 1.543911</span>
<span class="co">#&gt; epoch 9  loss: 1.566820</span>
<span class="co">#&gt; epoch 10  loss: 1.333689</span>

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>epoch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">loss_train</span><span class="op">)</span>, loss <span class="op">=</span> <span class="va">loss_train</span><span class="op">)</span> <span class="op"><a href="https://torch.mlverse.org/docs/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epoch</span>, y <span class="op">=</span> <span class="va">loss</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="cnn_zh_files/figure-html/unnamed-chunk-15-1.png" width="80%" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="经典模型" class="section level2">
<h2 class="hasAnchor">
<a href="#%E7%BB%8F%E5%85%B8%E6%A8%A1%E5%9E%8B" class="anchor"></a>经典模型</h2>
<p>如今有很多著名的 CNN 框架用于物体识别。这些著名的框架都已被安装在 torch/torchvision 包中。因此用户可以随时从 torch/torchvision 中调用，无需自己定义。下面是一个加载 ResNet 框架，并对网络进行训练的例子。由于 ResNet 包含大量的参数，想必我们自己定义的 SimpleNet，它需要更多的训练时间。</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/model_resnet18.html">model_resnet18</a></span><span class="op">(</span>pretrained <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">num_features</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="va">fc</span><span class="op">$</span><span class="va">in_features</span>
<span class="va">model</span><span class="op">$</span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="va">num_features</span>, out_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dataset_train</span><span class="op">$</span><span class="va">classes</span><span class="op">)</span><span class="op">)</span>
<span class="va">criterion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_cross_entropy_loss.html">nn_cross_entropy_loss</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">optimizer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/optim_sgd.html">optim_sgd</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="va">loss_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">loss_running</span> <span class="op">&lt;-</span> <span class="fl">0</span>
    <span class="va">n_train_samples</span> <span class="op">&lt;-</span> <span class="fl">0</span>

    <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="va">dataloader_train</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">optimizer</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span>
        <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
        <span class="va">loss</span> <span class="op">&lt;-</span> <span class="fu">criterion</span><span class="op">(</span><span class="va">output</span>, <span class="va">b</span><span class="op">$</span><span class="va">y</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
        <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span>
        <span class="va">optimizer</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span>
        
        <span class="va">loss_running</span> <span class="op">&lt;-</span> <span class="va">loss_running</span> <span class="op">+</span> <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
        <span class="va">n_train_samples</span> <span class="op">&lt;-</span> <span class="va">n_train_samples</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="va">loss_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">loss_train</span>, <span class="va">loss_running</span> <span class="op">/</span> <span class="va">n_train_samples</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"epoch %d  loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="va">loss_running</span> <span class="op">/</span> <span class="va">n_train_samples</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>epoch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">loss_train</span><span class="op">)</span>, loss <span class="op">=</span> <span class="va">loss_train</span><span class="op">)</span> <span class="op"><a href="https://torch.mlverse.org/docs/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epoch</span>, y <span class="op">=</span> <span class="va">loss</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div id="模型评估" class="section level3">
<h3 class="hasAnchor">
<a href="#%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0" class="anchor"></a>模型评估</h3>
<p>完成模型训练之后，我们将导入验证集来评估模型的性能。验证的过程与训练的过程相同：（i）对图像做预处理数据集并创建 <code>dataloader</code>，（ii）将 <code>dastaloader</code> 分配给模型。</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataset_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/image_folder_dataset.html">image_folder_dataset</a></span><span class="op">(</span><span class="st">'flower_photos_valid'</span>, transform <span class="op">=</span> <span class="va">valid_transforms</span><span class="op">)</span>
<span class="va">dataset_valid</span><span class="op">$</span><span class="va">classes</span>
<span class="co">#&gt; [1] "daisy"      "dandelion"  "roses"      "sunflowers" "tulips"</span>
<span class="va">dataloader_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset_valid</span>, batch_size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>导入验证集之后，我们可以用与训练模型同样的方法来评估模型。在评估过程中，将模型的切换至评估模式（<code>eval</code>）可以提高计算速度。</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span><span class="op">)</span>

<span class="va">y_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">y_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">loss_valid</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">n_valid_samples</span>  <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="va">dataloader_valid</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
    <span class="va">output_class_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_argmax.html">torch_argmax</a></span><span class="op">(</span><span class="va">output</span>, dim<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
    
    <span class="va">y_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">y_true</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>
    <span class="va">y_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">y_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">output_class_id</span><span class="op">)</span><span class="op">)</span>
      
    <span class="va">loss</span> <span class="op">&lt;-</span> <span class="fu">criterion</span><span class="op">(</span><span class="va">output</span>, <span class="va">b</span><span class="op">$</span><span class="va">y</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
    <span class="va">loss_valid</span> <span class="op">&lt;-</span> <span class="va">loss_valid</span> <span class="op">+</span> <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
    <span class="va">n_valid_samples</span> <span class="op">&lt;-</span> <span class="va">n_valid_samples</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">loss_valid</span> <span class="op">&lt;-</span> <span class="va">loss_valid</span> <span class="op">/</span> <span class="va">n_valid_samples</span>
<span class="va">acc_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y_true</span> <span class="op">==</span> <span class="va">y_pred</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_valid_samples</span>
<span class="va">acc_valid</span>
<span class="co">#&gt; [1] 0.4</span></code></pre></div>
<p>验证完毕后，我们绘制一个热图，来看看分类性能。</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y_true</span>
<span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 4 4 4 4 4 4 4 4</span>
<span class="co">#&gt; [39] 4 4 5 5 5 5 5 5 5 5 5 5</span>
<span class="va">y_pred</span>
<span class="co">#&gt;  [1] 2 2 2 2 2 4 2 4 2 2 2 2 2 2 2 4 2 2 2 2 4 3 3 3 3 3 3 2 1 3 4 2 2 4 2 4 2 4</span>
<span class="co">#&gt; [39] 2 2 3 3 4 3 4 3 2 3 3 3</span>

<span class="va">y_true_label</span> <span class="op">&lt;-</span> <span class="va">y_true</span>
<span class="va">y_pred_label</span> <span class="op">&lt;-</span> <span class="va">y_pred</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dataset_train</span><span class="op">$</span><span class="va">classes</span><span class="op">)</span><span class="op">)</span> <span class="va">y_true_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">y_true_label</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, <span class="va">dataset_train</span><span class="op">$</span><span class="va">classes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dataset_train</span><span class="op">$</span><span class="va">classes</span><span class="op">)</span><span class="op">)</span> <span class="va">y_pred_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">y_pred_label</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, <span class="va">dataset_train</span><span class="op">$</span><span class="va">classes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>

<span class="va">y_true_label</span>
<span class="co">#&gt;  [1] "daisy"      "daisy"      "daisy"      "daisy"      "daisy"     </span>
<span class="co">#&gt;  [6] "daisy"      "daisy"      "daisy"      "daisy"      "daisy"     </span>
<span class="co">#&gt; [11] "dandelion"  "dandelion"  "dandelion"  "dandelion"  "dandelion" </span>
<span class="co">#&gt; [16] "dandelion"  "dandelion"  "dandelion"  "dandelion"  "dandelion" </span>
<span class="co">#&gt; [21] "roses"      "roses"      "roses"      "roses"      "roses"     </span>
<span class="co">#&gt; [26] "roses"      "roses"      "roses"      "roses"      "roses"     </span>
<span class="co">#&gt; [31] "sunflowers" "sunflowers" "sunflowers" "sunflowers" "sunflowers"</span>
<span class="co">#&gt; [36] "sunflowers" "sunflowers" "sunflowers" "sunflowers" "sunflowers"</span>
<span class="co">#&gt; [41] "tulips"     "tulips"     "tulips"     "tulips"     "tulips"    </span>
<span class="co">#&gt; [46] "tulips"     "tulips"     "tulips"     "tulips"     "tulips"</span>
<span class="va">y_pred_label</span>
<span class="co">#&gt;  [1] "dandelion"  "dandelion"  "dandelion"  "dandelion"  "dandelion" </span>
<span class="co">#&gt;  [6] "sunflowers" "dandelion"  "sunflowers" "dandelion"  "dandelion" </span>
<span class="co">#&gt; [11] "dandelion"  "dandelion"  "dandelion"  "dandelion"  "dandelion" </span>
<span class="co">#&gt; [16] "sunflowers" "dandelion"  "dandelion"  "dandelion"  "dandelion" </span>
<span class="co">#&gt; [21] "sunflowers" "roses"      "roses"      "roses"      "roses"     </span>
<span class="co">#&gt; [26] "roses"      "roses"      "dandelion"  "daisy"      "roses"     </span>
<span class="co">#&gt; [31] "sunflowers" "dandelion"  "dandelion"  "sunflowers" "dandelion" </span>
<span class="co">#&gt; [36] "sunflowers" "dandelion"  "sunflowers" "dandelion"  "dandelion" </span>
<span class="co">#&gt; [41] "roses"      "roses"      "sunflowers" "roses"      "sunflowers"</span>
<span class="co">#&gt; [46] "roses"      "dandelion"  "roses"      "roses"      "roses"</span>

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">y_true_label</span>, predicted <span class="op">=</span> <span class="va">y_pred_label</span><span class="op">)</span> <span class="op"><a href="https://torch.mlverse.org/docs/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">label</span>, <span class="va">predicted</span><span class="op">)</span> <span class="op"><a href="https://torch.mlverse.org/docs/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n_images <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://torch.mlverse.org/docs/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">predicted</span>, y <span class="op">=</span> <span class="va">label</span>, fill <span class="op">=</span> <span class="va">n_images</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_fixed</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` has grouped output by 'label'. You can override using the `.groups` argument.</span></code></pre></div>
<p><img src="cnn_zh_files/figure-html/unnamed-chunk-19-1.png" width="80%" style="display: block; margin: auto;"></p>
</div>
<div id="模型御用" class="section level3">
<h3 class="hasAnchor">
<a href="#%E6%A8%A1%E5%9E%8B%E5%BE%A1%E7%94%A8" class="anchor"></a>模型御用</h3>
<p>在本小节中，我们将介绍运用训练好的模型来对图片进行分类。我们首先用 jpeg 包加载图片，然后用事先定义好的 <code>valid_transforms</code> 对其做预处理，随后代入模型即可。经过模型的计算，模型将会输出 <code>length(dataset_train$classes)</code> 个数值。这些数值可以被转换成蕾丝概率的数值。</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="st">'flower_photos/sunflowers/9410186154_465642ed35.jpg'</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">jpeg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jpeg/man/readJPEG.html">readJPEG</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">valid_transforms</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

<span class="va">x_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">x_batch</span><span class="op">[</span><span class="fl">1</span>,,,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">as.array</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">x_batch_tensor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">x_batch</span><span class="op">)</span>

<span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">x_batch_tensor</span><span class="op">)</span>
<span class="va">output</span>
<span class="co">#&gt; torch_tensor</span>
<span class="co">#&gt;  0.0711  0.1346 -0.2121  0.0163 -0.4177</span>
<span class="co">#&gt; [ CPUFloatType{1,5} ][ grad_fn = &lt;AddmmBackward&gt; ]</span>

<span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_softmax.html">nnf_softmax</a></span><span class="op">(</span><span class="va">output</span>, dim<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; torch_tensor</span>
<span class="co">#&gt;  0.2284  0.2433  0.1720  0.2162  0.1401</span>
<span class="co">#&gt; [ CPUFloatType{1,5} ][ grad_fn = &lt;SoftmaxBackward&gt; ]</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataset_train</span><span class="op">$</span><span class="va">classes</span>
<span class="co">#&gt; [1] "daisy"      "dandelion"  "roses"      "sunflowers" "tulips"</span></code></pre></div>
</div>
</div>
<div id="保存与读取模型" class="section level2">
<h2 class="hasAnchor">
<a href="#%E4%BF%9D%E5%AD%98%E4%B8%8E%E8%AF%BB%E5%8F%96%E6%A8%A1%E5%9E%8B" class="anchor"></a>保存与读取模型</h2>
<p>保存 torch 模型时需使用 <code>torch_save</code> 函数。使用 R 自带的 <code>save</code> 函数会将模型中不必要的变量也保存至文件中，而导致不能在其它计算机环境中再次利用该模型。</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_save.html">torch_save</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">'my_model.pth'</span><span class="op">)</span></code></pre></div>
<p>读取模型时使用 <code>torch_laod</code> 函数。由 <code>torch_load</code> 函数读取的模型可以再次用于预测或者再次训练。</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mymodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_load.html">torch_load</a></span><span class="op">(</span><span class="st">'my_model.pth'</span><span class="op">)</span>
<span class="va">mymodel</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="st">'flower_photos/sunflowers/9410186154_465642ed35.jpg'</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">jpeg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jpeg/man/readJPEG.html">readJPEG</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">valid_transforms</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

<span class="va">x_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">x_batch</span><span class="op">[</span><span class="fl">1</span>,,,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">as.array</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">x_batch_tensor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">x_batch</span><span class="op">)</span>

<span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">x_batch_tensor</span><span class="op">)</span>
<span class="va">output</span>

<span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_softmax.html">nnf_softmax</a></span><span class="op">(</span><span class="va">output</span>, dim<span class="op">=</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
</div>
<div id="系统环境" class="section level2">
<h2 class="hasAnchor">
<a href="#%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83" class="anchor"></a>系统环境</h2>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sessioninfo/man/session_info.html">session_info</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; ─ Session info  ──────────────────────────────────────────────────────────────</span>
<span class="co">#&gt;  hash: police officer: medium-light skin tone, flag: Cocos (Keeling) Islands, old woman: dark skin tone</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  setting  value</span>
<span class="co">#&gt;  version  R Under development (unstable) (2021-10-28 r81109)</span>
<span class="co">#&gt;  os       Ubuntu 20.04.3 LTS</span>
<span class="co">#&gt;  system   x86_64, linux-gnu</span>
<span class="co">#&gt;  ui       X11</span>
<span class="co">#&gt;  language (EN)</span>
<span class="co">#&gt;  collate  en_US.UTF-8</span>
<span class="co">#&gt;  ctype    en_US.UTF-8</span>
<span class="co">#&gt;  tz       Etc/UTC</span>
<span class="co">#&gt;  date     2021-10-31</span>
<span class="co">#&gt;  pandoc   2.14.0.3 @ /usr/local/bin/ (via rmarkdown)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ─ Packages ───────────────────────────────────────────────────────────────────</span>
<span class="co">#&gt;  package     * version date (UTC) lib source</span>
<span class="co">#&gt;  assertthat    0.2.1   2019-03-21 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  backports     1.3.0   2021-10-27 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  bit           4.0.4   2020-08-04 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  bit64         4.0.5   2020-08-30 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  broom         0.7.9   2021-07-27 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  cachem        1.0.6   2021-08-19 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  callr         3.7.0   2021-04-20 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  cellranger    1.1.0   2016-07-27 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  cli           3.1.0   2021-10-27 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  colorspace    2.0-2   2021-06-24 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  coro        * 1.0.1   2020-12-17 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  crayon        1.4.2   2021-10-29 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  DBI           1.1.1   2021-01-15 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  dbplyr        2.1.1   2021-04-06 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  desc          1.4.0   2021-09-28 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  devtools    * 2.4.2   2021-06-07 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  digest        0.6.28  2021-09-23 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  dplyr       * 1.0.7   2021-06-18 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  ellipsis      0.3.2   2021-04-29 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  evaluate      0.14    2019-05-28 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  fansi         0.5.0   2021-05-25 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  farver        2.1.0   2021-02-28 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  fastmap       1.1.0   2021-01-25 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  forcats     * 0.5.1   2021-01-27 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  fs            1.5.0   2020-07-31 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  generics      0.1.1   2021-10-25 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  ggplot2     * 3.3.5   2021-06-25 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  glue          1.4.2   2020-08-27 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  gtable        0.3.0   2019-03-25 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  haven         2.4.3   2021-08-04 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  highr         0.9     2021-04-16 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  hms           1.1.1   2021-09-26 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  htmltools     0.5.2   2021-08-25 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  httr          1.4.2   2020-07-20 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  jpeg        * 0.1-9   2021-07-24 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  jsonlite      1.7.2   2020-12-09 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  knitr         1.36    2021-09-29 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  labeling      0.4.2   2020-10-20 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  lifecycle     1.0.1   2021-09-24 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  lubridate     1.8.0   2021-10-07 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  magrittr      2.0.1   2020-11-17 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  memoise       2.0.0   2021-01-26 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  modelr        0.1.8   2020-05-19 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  munsell       0.5.0   2018-06-12 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  pillar        1.6.4   2021-10-18 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  pkgbuild      1.2.0   2020-12-15 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  pkgconfig     2.0.3   2019-09-22 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  pkgdown       1.6.1   2020-09-12 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  pkgload       1.2.3   2021-10-13 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  prettyunits   1.1.1   2020-01-24 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  processx      3.5.2   2021-04-30 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  ps            1.6.0   2021-02-28 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  purrr       * 0.3.4   2020-04-17 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  R6            2.5.1   2021-08-19 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  ragg          1.2.0   2021-10-30 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  Rcpp          1.0.7   2021-07-07 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  readr       * 2.0.2   2021-09-27 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  readxl        1.3.1   2019-03-13 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  remotes       2.4.1   2021-09-29 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  reprex        2.0.1   2021-08-05 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  rlang         0.4.12  2021-10-18 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  rmarkdown     2.11    2021-09-14 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  rprojroot     2.0.2   2020-11-15 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  rstudioapi    0.13    2020-11-12 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  rvest         1.0.2   2021-10-16 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  scales        1.1.1   2020-05-11 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  sessioninfo   1.2.0   2021-10-31 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  stringi       1.7.5   2021-10-04 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  stringr     * 1.4.0   2019-02-10 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  systemfonts   1.0.3   2021-10-13 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  testthat      3.1.0   2021-10-04 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  textshaping   0.3.6   2021-10-13 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  tibble      * 3.1.5   2021-09-30 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  tidyr       * 1.1.4   2021-09-27 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  tidyselect    1.1.1   2021-04-30 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  tidyverse   * 1.3.1   2021-04-15 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  torch       * 0.6.0   2021-10-07 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  torchvision * 0.4.0   2021-08-17 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  tzdb          0.2.0   2021-10-27 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  usethis     * 2.1.3   2021-10-27 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  utf8          1.2.2   2021-07-24 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  vctrs         0.3.8   2021-04-29 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  withr         2.4.2   2021-04-18 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  xfun          0.27    2021-10-18 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  xml2          1.3.2   2020-04-23 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt;  yaml          2.2.1   2020-02-01 [2] CRAN (R 4.2.0)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [1] /tmp/RtmpvfiGT9/temp_libpath2a344ca05124</span>
<span class="co">#&gt;  [2] /usr/local/lib/R/site-library</span>
<span class="co">#&gt;  [3] /usr/local/lib/R/library</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ──────────────────────────────────────────────────────────────────────────────</span></code></pre></div>
</div>
<div id="参考文献" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE" class="anchor"></a>参考文献</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-coro" class="csl-entry">
Henry, Lionel. 2021. <span>“Coro: ’Coroutines’ for r.”</span> <a href="ttps://cran.r-project.org/package=coro">ttps://cran.r-project.org/package=coro</a>.
</div>
<div id="ref-torch4r" class="csl-entry">
PBC, RStudio. 2021. <span>“Torch for r.”</span> <a href="https://torch.mlverse.org/">https://torch.mlverse.org/</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jianqiang Sun.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
