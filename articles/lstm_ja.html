<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>深層学習を利用した CRISPR guide RNA の活性予測 • Intro2DNN</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="深層学習を利用した CRISPR guide RNA の活性予測">
<meta property="og:description" content="Intro2DNN">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Intro2DNN</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cnn.html">Introduction to image recognition with deep learning</a>
    </li>
    <li>
      <a href="../articles/cnn_zh.html">物体识别入门</a>
    </li>
    <li>
      <a href="../articles/lstm.html">Prediction of CRISPR guide RNA activity with deep learning</a>
    </li>
    <li>
      <a href="../articles/lstm_ja.html">深層学習を利用した CRISPR guide RNA の活性予測</a>
    </li>
    <li>
      <a href="../articles/lstm_zh.html">基于深度学习预测 CRISPR guide RNA 的切割效率</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jsun/Intro2DNN">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="lstm_ja_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>深層学習を利用した CRISPR guide RNA の活性予測</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jsun/Intro2DNN/blob/master/vignettes/lstm_ja.Rmd"><code>vignettes/lstm_ja.Rmd</code></a></small>
      <div class="hidden name"><code>lstm_ja.Rmd</code></div>

    </div>

    
    
<div id="概要" class="section level2">
<h2 class="hasAnchor">
<a href="#%E6%A6%82%E8%A6%81" class="anchor"></a>概要</h2>
<p>深層学習は画像認識や自然言語処理の分野で大きな成功を収め、様々な分野に取り入れられている。生命科学の分野においても、深層学習を利用して様々な問題を解決しようと試みられている。深層学習は、ニューラルネットワークとよばれる従来の学習アルゴリズムを深層化したものである。こうして深層化されたニューラルネットワークは、従来で解くのが難しい問題でも、解けるようになったりする。現在、多様な深層ニューラルネットワークの構造が発表されている。とりわけ、畳み込みニューラルネットワーク (Convolutional Neural Network; CNN) および再帰型ニューラルネットワーク (Recurrent Neural Network; RNN) が一躍有名である。前者の CNN は画像認識などのコンピュータビジョンに優れ、後者の RNN は時系列データ解析や自然言語処理などに優れていることが知られている。本ワークショップでは、Bioconductor ユーザーにゲノム配列解析者が多いことを受け、今回は後者の RNN の仕組みを紹介するとともに、R を使った RNN モデルの構築方法も紹介する。</p>
<div id="目標" class="section level3">
<h3 class="hasAnchor">
<a href="#%E7%9B%AE%E6%A8%99" class="anchor"></a>目標</h3>
<p>本ワークショップでは、具体的に CRISPR/Cas9 システムにおける guide RNA の塩基配列から変異の導入確率を予測するモデルを開発することを通して、RNN およびそれに似た長・短期記憶 (Long short-term memory; LSTM) を学ぶ。本ワークショップに参加することで、以下の基本知識を学ぶことができる。</p>
<ul>
<li>ニューラルネットワークの基本</li>
<li>再帰型ニューラルネットワークの基本</li>
<li>R (torch パッケージ) を利用した深層学習の進め方</li>
</ul>
</div>
<div id="レベル" class="section level3">
<h3 class="hasAnchor">
<a href="#%E3%83%AC%E3%83%99%E3%83%AB" class="anchor"></a>レベル</h3>
<p>本ワークショップでは、参加者が以下の基本知識を持つ前提で進める。</p>
<ul>
<li>R の基本的な使い方（パッケージのインストール、ファイルの読み書き、<code>for</code> 構文、関数の定義など）</li>
<li>高校レベルの数学（多変量関数、一次結合、微分など）</li>
</ul>
<p>なお、本ワークショップでは、深層学習の入門知識を中心に解説するため、すでに深層学習を熟知している者や Python あるいは他のプログラミング言語でモデルを構築できる者を対象としていない。</p>
</div>
</div>
<div id="解析環境" class="section level2">
<h2 class="hasAnchor">
<a href="#%E8%A7%A3%E6%9E%90%E7%92%B0%E5%A2%83" class="anchor"></a>解析環境</h2>
<p>本ワークショップでは主に torch <span class="citation">(PBC 2021)</span> および coro <span class="citation">(Henry 2021)</span> パッケージ を利用して深層学習を進める。また、tidyverse パッケージ を利用して予測結果の可視化などを行う。これらのパッケージをインストールするには、R を起動して次のスクリプトを実行する。</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'tidyverse'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'coro'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'torch'</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://torch.mlverse.org/docs">'torch'</a></span><span class="op">)</span>
<span class="fu"><a href="https://torch.mlverse.org/docs/reference/install_torch.html">install_torch</a></span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">1200</span><span class="op">)</span></code></pre></div>
<p>パッケージをインストールした後に、R を再起動し、これらのパッケージを呼び出しておく。</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyverse.tidyverse.org">'tidyverse'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/r-lib/coro">'coro'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://torch.mlverse.org/docs">'torch'</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="データセット" class="section level2">
<h2 class="hasAnchor">
<a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88" class="anchor"></a>データセット</h2>
<div id="データセットの読み込み" class="section level3">
<h3 class="hasAnchor">
<a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF" class="anchor"></a>データセットの読み込み</h3>
<p>本ワークショップで使用するデータは <span class="citation">Wang D (2019)</span> らの論文の Supplementary Data からダウンロードできる。時間の関係上、ここでは予めダウンロードしてテキストデータに整理しておいたものを用いる。これらのデータは Intro2DNN パッケージに含まれている。また、<a href="https://github.com/jsun/Intro2DNN">GitHub</a> からもダウンロードできる。これらの整形済みのデータは <em>train.tsv</em> および <em>valid.tsv</em> ファイルからなり、それぞれが訓練データ（学習データ）と検証データにあたる。</p>
<p>ここで、まず訓練データ <em>train.csv</em> を読み込んでから前処理を行う例を示す。</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train_fpath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">'train.tsv'</span>, package <span class="op">=</span> <span class="st">'Intro2DNN'</span><span class="op">)</span>
<span class="va">crisprcas9_train_dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="va">train_fpath</span>, header <span class="op">=</span> <span class="cn">FALSE</span>, sep <span class="op">=</span> <span class="st">'\t'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">crisprcas9_train_dataset</span><span class="op">)</span></code></pre></div>
<p>このように <em>train.tsv</em> ファイルに保存されているデータは 2 列からなり、1 列目が編集効率、2 列目が guide RNA の塩基配列となっている。</p>
</div>
<div id="前処理" class="section level3">
<h3 class="hasAnchor">
<a href="#%E5%89%8D%E5%87%A6%E7%90%86" class="anchor"></a>前処理</h3>
<p>我々の目的は、guide RNA の塩基配列を入力し、編集効率を予測するモデルを構築することである。そのため、<em>train.tsv</em> から読み込んだ編集効率と塩基配列を扱いやすいように、それぞれ教師ラベル（目的変数） <code>y_train</code> 変数と特徴量（説明変数） <code>x_train</code> 変数に分けて保存する。</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">crisprcas9_train_dataset</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>
<span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">crisprcas9_train_dataset</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></code></pre></div>
<p>特徴量 <code>x_train</code> は A, C, G, T からなる文字の羅列となっている。しかし、torch を含むほとんどの機械学習のパッケージでは数値しか扱えない。そのため、これらの文字列となっている特徴量を数値に変換しなければならない。ここでは、A を 1 に、T を 2 に、C を 3 に、G を 4 に変換しておく。この変換を行うには、次のように <code>chartr</code> 関数および <code>strsplit</code> 関数を用いる。試しに <code>x_train</code> の最初の要素を変換してみる。</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/chartr.html">chartr</a></span><span class="op">(</span><span class="st">'ATCG'</span>, <span class="st">'1234'</span>, <span class="va">x_train</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html">chartr</a></span><span class="op">(</span><span class="st">'ATCG'</span>, <span class="st">'1234'</span>, <span class="va">x_train</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="st">''</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>このように動作確認を行った後、<code>x_train</code> のすべての要素に対して変換を行う。変換後、21 塩基の guide RNA の配列は 21 個の整数値になる。これら 21 個の整数値がその guide RNA を表す特徴量となる。</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html">chartr</a></span><span class="op">(</span><span class="st">'ATCG'</span>, <span class="st">'1234'</span>, <span class="va">x_train</span><span class="op">)</span>, <span class="st">''</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                  ncol <span class="op">=</span> <span class="fl">21</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">x_train</span><span class="op">)</span></code></pre></div>
<p>ここまでの手順で、ファイルに保存されたデータを読み込み、整形し、R のオブジェクトに保存することができた。しかし、torch パッケージは、このように保存されたデータを直接読み取ることができない。そこで、この R オブジェクトを torch パッケージが読み取れるように変換するためのクラス（関数の集まり）を作成する。</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">set_dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/dataset.html">dataset</a></span><span class="op">(</span>
    <span class="st">'guidRNA_dataset'</span>,
    
    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span>
        <span class="va">self</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y</span>
    <span class="op">}</span>,
    
    .getitem <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">x_tensor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
        <span class="va">y_tensor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_tensor</span>, y <span class="op">=</span> <span class="va">y_tensor</span><span class="op">)</span>
    <span class="op">}</span>,
    
    .length <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
    <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<p>訓練データを上で定義した <code>set_dataset</code> クラスに代入し、変換を行う。続けて、モデルの学習時に、データをどのようにモデルに与えるのかを制御するためのオブジェクトを生成する。</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataset_train</span> <span class="op">&lt;-</span> <span class="fu">set_dataset</span><span class="op">(</span><span class="va">x_train</span>, <span class="va">y_train</span><span class="op">)</span>
<span class="va">dataloader_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset_train</span>, batch_size <span class="op">=</span> <span class="fl">1024</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>以上の手順で、訓練データの使用準備が終わる。これまでの操作により、<code>x_train</code> および <code>y_train</code> の情報がペアとなって <code>dataloader_train</code> に保存される。モデル学習時に、この <code>dataloader_train</code> からデータを少しずつ（1 バッチずつ、すなわち 1024 サンプル）取り出して学習を行う。</p>
</div>
</div>
<div id="モデル構築" class="section level2">
<h2 class="hasAnchor">
<a href="#%E3%83%A2%E3%83%87%E3%83%AB%E6%A7%8B%E7%AF%89" class="anchor"></a>モデル構築</h2>
<div id="モデル設計" class="section level3">
<h3 class="hasAnchor">
<a href="#%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%AD%E8%A8%88" class="anchor"></a>モデル設計</h3>
<p>torch パッケージを利用して予測モデルを作成するには、まず torch パッケージで用意された基本関数を使って、モデル（ネットワーク）の設計図を作成することから始める。ここでは、21 個の整数値（特徴量）を受け取り、1 個の実数値（教師ラベル）を出力するようなネットワーク構造を設計することにする。具体的に次のようなネットワークを設計してみる。まず 4 次元（A, C, G, T）からなる 21 個の整数値を embedding 層に入力し、これらをの次元数を 64 次元に増やす。続けて、これらを LSTM 層に代入し 256 個の特徴を抽出する。最後に LSTM 層で抽出された特徴を 3 層からなる全結合層に代入して、1 つの実数値を出力するようにする。</p>
<p>このようなネットワークを定義するには、まず torch で定義された手続きにしたがって、<code>initialize</code> 関数および <code>forward</code> 関数からなるクラス（関数群）を作成する。<code>initialize</code> 関数でネットワークの部品を宣言し、<code>forward</code> 関数でそれぞれの部品を繋ぎ合わせる順序を定義する。</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">GenomicNet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_module.html">nn_module</a></span><span class="op">(</span>
    <span class="st">"GenomicNet"</span>,
  
    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">self</span><span class="op">$</span><span class="va">embedding</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_embedding.html">nn_embedding</a></span><span class="op">(</span>num_embeddings <span class="op">=</span> <span class="fl">4</span>, embedding_dim <span class="op">=</span> <span class="fl">64</span><span class="op">)</span>
        <span class="va">self</span><span class="op">$</span><span class="va">lstm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_lstm.html">nn_lstm</a></span><span class="op">(</span>input_size <span class="op">=</span> <span class="fl">64</span>, hidden_size <span class="op">=</span> <span class="fl">256</span>, batch_first <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
        <span class="va">self</span><span class="op">$</span><span class="va">dropout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_dropout.html">nn_dropout</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
        <span class="va">self</span><span class="op">$</span><span class="va">fc1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">256</span>, out_features <span class="op">=</span> <span class="fl">512</span><span class="op">)</span>
        <span class="va">self</span><span class="op">$</span><span class="va">fc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">512</span>, out_features <span class="op">=</span> <span class="fl">512</span><span class="op">)</span>
        <span class="va">self</span><span class="op">$</span><span class="va">fc3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">512</span>, out_features <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span>,
  
    forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">embedding</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">lstm</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span>, , <span class="op">]</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">fc1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">dropout</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">fc2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">dropout</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">fc3</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="モデル学習" class="section level3">
<h3 class="hasAnchor">
<a href="#%E3%83%A2%E3%83%87%E3%83%AB%E5%AD%A6%E7%BF%92" class="anchor"></a>モデル学習</h3>
<p>次にモデルの設計図からモデル実体を作り、学習データを流し込んでモデルの学習を行う例を示す。まず、設計図から実体を作成する。</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">GenomicNet</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>次に、モデルに訓練データを与えて学習させるが、そのときに使用するアルゴリズムを指定する。</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">criterion</span> <span class="op">&lt;-</span> <span class="va">nnf_mse_loss</span>
<span class="va">optimizer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/optim_adam.html">optim_adam</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span></code></pre></div>
<p>以上により、データ、モデル、学習パラメーターの準備が完了した。続けて、必要に応じて、これらをデバイス（CPU または GPU）上に送り、学習を開始する。学習を行う際に、<code>for</code> 構文を使用して同じデータセットを 5 回（エポック）繰り返し学習するように制御する。また、各エポックにおいて、予め <code>dataloader</code> で定義したミニバッチ数で少しずつ学習させる。</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span>
<span class="va">model</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="op">)</span>

<span class="va">loss_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">loss_running</span> <span class="op">&lt;-</span> <span class="fl">0</span>
    <span class="va">n_train_samples</span> <span class="op">&lt;-</span> <span class="fl">0</span>

    <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="va">dataloader_train</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">optimizer</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span>
        <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
        <span class="va">loss</span> <span class="op">&lt;-</span> <span class="fu">criterion</span><span class="op">(</span><span class="va">output</span>, <span class="va">b</span><span class="op">$</span><span class="va">y</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
        <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span>
        <span class="va">optimizer</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span>
        
        <span class="va">loss_running</span> <span class="op">&lt;-</span> <span class="va">loss_running</span> <span class="op">+</span> <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
        <span class="va">n_train_samples</span> <span class="op">&lt;-</span> <span class="va">n_train_samples</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="va">loss_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">loss_train</span>, <span class="va">loss_running</span> <span class="op">/</span> <span class="va">n_train_samples</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"epoch %d  loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="va">loss_running</span> <span class="op">/</span> <span class="va">n_train_samples</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>このモデルは、学習を通して損失が徐々に減少する。実際に、各エポックの損失をグラフで示すと、次のように減少傾向が見られる。また、5 エポックまでの損失の減少の勢いがそれほど弱まっていないことも読み取れる。そのため、より大きなエポック数を設定することで、損失をさらに減らすことができると考えられる。</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>epoch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">loss_train</span><span class="op">)</span>, loss <span class="op">=</span> <span class="va">loss_train</span><span class="op">)</span> <span class="op"><a href="https://torch.mlverse.org/docs/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epoch</span>, y <span class="op">=</span> <span class="va">loss</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>ここでさらに 5 エポック追加学習を行ってみることにする。</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span> <span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">6</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">loss_running</span> <span class="op">&lt;-</span> <span class="fl">0</span>
    <span class="va">n_train_samples</span> <span class="op">&lt;-</span> <span class="fl">0</span>

    <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="va">dataloader_train</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">optimizer</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span>
        <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
        <span class="va">loss</span> <span class="op">&lt;-</span> <span class="fu">criterion</span><span class="op">(</span><span class="va">output</span>, <span class="va">b</span><span class="op">$</span><span class="va">y</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
        <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span>
        <span class="va">optimizer</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span>
        
        <span class="va">loss_running</span> <span class="op">&lt;-</span> <span class="va">loss_running</span> <span class="op">+</span> <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
        <span class="va">n_train_samples</span> <span class="op">&lt;-</span> <span class="va">n_train_samples</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="va">loss_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">loss_train</span>, <span class="va">loss_running</span> <span class="op">/</span> <span class="va">n_train_samples</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"epoch %d  loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="va">loss_running</span> <span class="op">/</span> <span class="va">n_train_samples</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>


<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>epoch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">loss_train</span><span class="op">)</span>, loss <span class="op">=</span> <span class="va">loss_train</span><span class="op">)</span> <span class="op"><a href="https://torch.mlverse.org/docs/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epoch</span>, y <span class="op">=</span> <span class="va">loss</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="性能検証" class="section level3">
<h3 class="hasAnchor">
<a href="#%E6%80%A7%E8%83%BD%E6%A4%9C%E8%A8%BC" class="anchor"></a>性能検証</h3>
<p>学習を終えたモデルに、学習に使わなかったデータを与えて、未知のデータに対する予測性能を検証する。検証時の手順は、学習時の手順と同じように、データの読み取りと前処理を行って <code>dataloader</code> を作成し、それを学習済みのモデルに代入して、検証を行う。まず、データの読み取りと前処理を行う。</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valid_fpath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">'valid.tsv'</span>, package <span class="op">=</span> <span class="st">'Intro2DNN'</span><span class="op">)</span>
<span class="va">crisprcas9_valid_dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="va">valid_fpath</span>, header <span class="op">=</span> <span class="cn">FALSE</span>, sep <span class="op">=</span> <span class="st">'\t'</span><span class="op">)</span>

<span class="va">x_valid</span> <span class="op">&lt;-</span> <span class="va">crisprcas9_valid_dataset</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>
<span class="va">y_valid</span> <span class="op">&lt;-</span> <span class="va">crisprcas9_valid_dataset</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>

<span class="va">x_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html">chartr</a></span><span class="op">(</span><span class="st">'ATCG'</span>, <span class="st">'1234'</span>, <span class="va">x_valid</span><span class="op">)</span>, <span class="st">''</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                  ncol <span class="op">=</span> <span class="fl">21</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">dataset_valid</span> <span class="op">&lt;-</span> <span class="fu">set_dataset</span><span class="op">(</span><span class="va">x_valid</span>, <span class="va">y_valid</span><span class="op">)</span>
<span class="va">dataloader_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset_valid</span>, batch_size <span class="op">=</span> <span class="fl">1024</span>, shuffle <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>次に、<code>for</code> 文を使って、検証データを 1 バッチずつモデルに代入して予測結果を得る。なお、モデル検証を行うときは、モデルを検証モード（評価モード）に切り替える。</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span><span class="op">)</span>

<span class="va">y_true</span> <span class="op">&lt;-</span> <span class="va">y_valid</span>
<span class="va">y_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">loss_valid</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">n_valid_samples</span>  <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="va">dataloader_valid</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
    <span class="va">y_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">y_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span>
    <span class="va">loss</span> <span class="op">&lt;-</span> <span class="fu">criterion</span><span class="op">(</span><span class="va">output</span>, <span class="va">b</span><span class="op">$</span><span class="va">y</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
    
    <span class="va">loss_valid</span> <span class="op">&lt;-</span> <span class="va">loss_valid</span> <span class="op">+</span> <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
    <span class="va">n_valid_samples</span> <span class="op">&lt;-</span> <span class="va">n_valid_samples</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">loss_valid</span> <span class="op">&lt;-</span> <span class="va">loss_valid</span> <span class="op">/</span> <span class="va">n_valid_samples</span>
<span class="va">loss_valid</span></code></pre></div>
<p>検証データをモデルに入力して予測した値 <code>y_pred</code> と実験値 <code>y_true</code> の相関を散布図で確認する。</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">y_true</span>, predicted <span class="op">=</span> <span class="va">y_pred</span><span class="op">)</span> <span class="op"><a href="https://torch.mlverse.org/docs/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">label</span>, y <span class="op">=</span> <span class="va">predicted</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>モデル検証において損失として平均二乗誤差 (Mean Square Error; MSE) を計算しているが、測定値と予測値を使って定義式にしたがって計算することもできる。また、原著論文 <span class="citation">(Wang D 2019)</span> のようにスピアマンの順位相関係数を計算することもできる。</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># MSE</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_true</span> <span class="op">-</span> <span class="va">y_pred</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y_true</span><span class="op">)</span>

<span class="co"># correlation</span>
<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">y_true</span>, <span class="va">y_pred</span>, method <span class="op">=</span> <span class="st">'spearman'</span><span class="op">)</span></code></pre></div>
</div>
<div id="推論" class="section level3">
<h3 class="hasAnchor">
<a href="#%E6%8E%A8%E8%AB%96" class="anchor"></a>推論</h3>
<p>学習および検証の終えたモデルを使って、実際に推論を行う例を示す。推論を行うには検証時に使ったコードをそのまま使用しても構わないが、ここでは guide RNA の塩基配列を代入して編集効率を出力するような流れで推論を行う例を示す。</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="st">'GAGTGATGATGGTCTGCACAC'</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html">chartr</a></span><span class="op">(</span><span class="st">'ATCG'</span>, <span class="st">'1234'</span>, <span class="va">x</span><span class="op">)</span>, <span class="st">''</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                  ncol <span class="op">=</span> <span class="fl">21</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">x</span>

<span class="va">x_tensor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">x_tensor</span>

<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">x_tensor</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span>
<span class="va">y</span></code></pre></div>
</div>
</div>
<div id="モデルの書き出しと読み込み" class="section level2">
<h2 class="hasAnchor">
<a href="#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E6%9B%B8%E3%81%8D%E5%87%BA%E3%81%97%E3%81%A8%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF" class="anchor"></a>モデルの書き出しと読み込み</h2>
<p>学習と検証を終えたモデルは <code>torch_save</code> 関数を使って保存することができる。なお、R の <code>save</code> 関数を使うと、一部の環境依存のパラメーターが環境依存のままで保存されるため、他の環境（コンピュータ）でモデルを呼び出せなくなる。</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_save.html">torch_save</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">'my_model.pth'</span><span class="op">)</span></code></pre></div>
<p>モデルの呼び出しは <code>torch_laod</code> 関数を使用する。<code>torch_laod</code> 関数で呼び出したモデルに対して、推論に利用したり、再学習させたりすることができる。</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mymodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_load.html">torch_load</a></span><span class="op">(</span><span class="st">'my_model.pth'</span><span class="op">)</span>
<span class="va">mymodel</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="st">'GAGTGATGATGGTCTGCACAC'</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html">chartr</a></span><span class="op">(</span><span class="st">'ATCG'</span>, <span class="st">'1234'</span>, <span class="va">x</span><span class="op">)</span>, <span class="st">''</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                  ncol <span class="op">=</span> <span class="fl">21</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">x_tensor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">x_tensor</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">mymodel</span><span class="op">(</span><span class="va">x_tensor</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="st">'cpu'</span><span class="op">)</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span>
<span class="va">y</span></code></pre></div>
</div>
<div id="参考文献" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE" class="anchor"></a>参考文献</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-coro" class="csl-entry">
Henry, Lionel. 2021. <span>“Coro: ’Coroutines’ for r.”</span> <a href="ttps://cran.r-project.org/package=coro">ttps://cran.r-project.org/package=coro</a>.
</div>
<div id="ref-torch4r" class="csl-entry">
PBC, RStudio. 2021. <span>“Torch for r.”</span> <a href="https://torch.mlverse.org/">https://torch.mlverse.org/</a>.
</div>
<div id="ref-Wang_2019" class="csl-entry">
Wang D, Wang B, Zhang C. 2019. <span>“Optimized CRISPR Guide RNA Design for Two High-Fidelity Cas9 Variants by Deep Learning.”</span> <em>Nat Commun</em> 10(1): 4284. <a href="https://doi.org/10.1038/s41467-019-12281-8">https://doi.org/10.1038/s41467-019-12281-8</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jianqiang Sun.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
